{"version":3,"file":"store.manager.js","sources":["../src/store.manager.js"],"sourcesContent":["/**\n * @Author: houshengwei\n * @Date:   2018/07/22\n * @Last modified by:   houshengwei\n * @Last modified time: 2018/07/22\n */\n\nclass StoreManager {\n  constructor (args) {\n    this.args = args\n    this.instance = ''\n    this.executing = false\n  }\n\n  _getType (any) {\n    return Object.prototype.toString.call(any).slice(8, -1)\n  }\n\n  start (...args) {\n    if (!this.instance) {\n      this.instance = new StoreManager(args)\n\n      let url = window.location.href\n      let [rules = [], $store, ...rest] = args\n\n      window.addEventListener('hashchange', () => {\n        this.instance && this.instance.updateStore()\n      })\n      window.addEventListener('popstate', () => {\n        this.instance && this.instance.updateStore()\n      })\n\n      $store.registerModule('_storeManage_', {\n        namespaced: true,\n        state: {\n          version: '0.0.1',\n          'MOUNTED': ''\n        },\n        mutations: {\n          'MOUNTED' (state, payload) {\n            state['MOUNTED'] = payload\n          }\n        }\n      })\n    }\n\n    return this.instance\n  }\n\n  updateStore (url) {\n    if (this.executing) return\n\n    try {\n      url = url || window.location.href\n      if (!url) throw ''\n    } catch (e) {\n      throw new Error('非浏览器环境时,需要提供参数: 匹配对象<String>, 如url等')\n    }\n    this.executing = true\n\n    let [rules, $store, ...rest] = this.args\n    let matched = []\n    let notMatched = []\n    let mounted = []\n\n    rules.forEach(item => {\n      let isMatched\n      if (this._getType(item.rule) === 'RegExp') {\n        isMatched = item.rule.test(url)\n      } else if (this._getType(item.rule) === 'Function') {\n        isMatched = item.rule(url, ...this.args)\n      } else {\n        throw new Error('Expected the `rule` to be a function or regExp.')\n      }\n      if (isMatched) {\n        matched.push(item)\n      } else {\n        notMatched.push(item)\n      }\n    })\n\n    matched.forEach(item => {\n      let {name, module} = item\n      if (!name || !module) {\n        throw new Error('Missing `name` or `module` for rules')\n      }\n\n      if (module.namespaced !== false) {\n        module.namespaced = true\n      }\n\n      if ($store.state[name] === undefined) {\n        $store.registerModule(name, module)\n      }\n\n      mounted.push(name)\n    })\n\n    setTimeout(() => {\n      notMatched.forEach(item => {\n        let moduleName = item.name\n        $store.state[moduleName] && $store.unregisterModule(moduleName)\n      })\n\n      $store.commit('_storeManage_/MOUNTED', `_${mounted.join('_')}_`)\n      this.executing = false\n    }, 100)\n  }\n}\n\nlet storeManager = new StoreManager()\nexport default storeManager\n"],"names":["StoreManager","args","instance","executing","any","Object","prototype","toString","call","slice","url","window","location","href","rules","$store","rest","addEventListener","updateStore","registerModule","state","payload","e","Error","matched","notMatched","mounted","forEach","isMatched","_getType","item","rule","test","push","name","module","namespaced","undefined","moduleName","unregisterModule","commit","join","storeManager"],"mappings":"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"}